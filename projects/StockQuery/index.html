<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> StockQuery TCP Client/Server (C) | Tongze Mao </title> <meta name="author" content="Tongze Mao"> <meta name="description" content="A compact client–server system in C for querying historical stock data."> <meta name="keywords" content="Tongze Mao, Computer Science, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?86fbbecec189054f486c8d20d21d47df" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/notion_tran.ico?77fbfb63394a7e37d18d66a902a5f583"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://t-mao.github.io/projects/StockQuery/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Tongze</span> Mao </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">StockQuery TCP Client/Server (C)</h1> <p class="post-description">A compact client–server system in C for querying historical stock data.</p> </header> <article> <div class="row"> <div class="col-sm mt-3 mt-md-0 text-center"> <figure> <picture> <source class="responsive-img-srcset" srcset="https://tse3.mm.bing.net/th/id/OIP.jS0f3A9bdLncOxrFKeFWoQHaD4?r=0&amp;w=474&amp;h=474&amp;c=7&amp;p=0" sizes="95vw"></source> <img src="https://tse3.mm.bing.net/th/id/OIP.jS0f3A9bdLncOxrFKeFWoQHaD4?r=0&amp;w=474&amp;h=474&amp;c=7&amp;p=0" class="rounded z-depth-0" width="100%" height="auto" style=" max-width: 300px; " title="StockQuery" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h2 id="overview">Overview</h2> <p>This was a group assignment to build a networked client and server in <strong>C</strong> that exchange custom binary-framed messages over <strong>TCP</strong> and serve historical prices for two equities. I implemented the socket layer, message framing, command parsing, and the analytics logic for computing optimal profit or loss over a date interval. The system loads prices from CSV, answers queries on demand, and returns results in a compact, length-prefixed format.</p> <p>The project exercised low-level networking, robust string handling, defensive CSV parsing, and algorithm design under an explicit message budget of <strong>less than 256 bytes per frame</strong>.</p> <p><br></p> <h2 id="features-at-a-glance">Features at a Glance</h2> <ul> <li> <strong>Binary framing</strong> with a 1-byte length prefix and ASCII payload</li> <li> <strong>Two commands</strong>: <code class="language-plaintext highlighter-rouge">PricesOnDate &lt;YYYY-MM-DD&gt;</code> and <code class="language-plaintext highlighter-rouge">MaxPossible &lt;profit|loss&gt; &lt;PFE|MRNA&gt; &lt;start&gt; &lt;end&gt;</code> </li> <li> <strong>CSV-backed dataset</strong> for PFE and MRNA, using the <strong>Close</strong> column and rounding to two decimals as specified</li> <li> <strong>Single-client server</strong> with continuous request handling until terminated by the operator</li> <li> <strong>Client REPL</strong> prompt with immediate responses and graceful exit on <code class="language-plaintext highlighter-rouge">quit</code> </li> </ul> <p><br></p> <h2 id="architecture">Architecture</h2> <ul> <li> <strong>Protocol</strong>: Each frame begins with a single byte <code class="language-plaintext highlighter-rouge">n</code> followed by <code class="language-plaintext highlighter-rouge">n</code> bytes of UTF-8/ASCII text. This meets the maximum message length requirement and keeps parsing trivial on both sides.</li> <li> <strong>Server</strong>: Preloads two price tables into memory, listens on a chosen port, and handles one connected client at a time.</li> <li> <strong>Client</strong>: Opens a TCP connection, frames each user command into a binary message, and prints the returned payload.</li> </ul> <p><br></p> <h2 id="command-set-and-data-model">Command Set and Data Model</h2> <p><strong>Commands</strong></p> <ul> <li> <p><code class="language-plaintext highlighter-rouge">PricesOnDate &lt;YYYY-MM-DD&gt;</code> Returns <code class="language-plaintext highlighter-rouge">PFE: &lt;price&gt; | MRNA: &lt;price&gt;</code> for the given date, or <code class="language-plaintext highlighter-rouge">Unknown</code> if the date is not found.</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">MaxPossible &lt;profit|loss&gt; &lt;PFE|MRNA&gt; &lt;start-date&gt; &lt;end-date&gt;</code> Returns a single decimal value representing the best achievable one-share profit or loss when buy and sell are ordered in time.</p> </li> </ul> <p><strong>Dataset</strong></p> <ul> <li>Source files: <code class="language-plaintext highlighter-rouge">PFE.csv</code>, <code class="language-plaintext highlighter-rouge">MRNA.csv</code> </li> <li>Date coverage: trading days between 2019-07-02 and 2021-06-30</li> <li>Field used: <strong>Close</strong> </li> <li>Rounding: values are rounded to two decimals</li> </ul> <p><br></p> <h2 id="selected-implementation-details">Selected Implementation Details</h2> <h3 id="length-prefixed-framing">Length-Prefixed Framing</h3> <p>The client constructs an output buffer where byte 0 stores <code class="language-plaintext highlighter-rouge">strlen(payload)</code>, followed by the bytes of the payload. The server reads a buffer, prints the received command for observability, and replies with a similarly framed buffer. This format is compact, quick to parse, and prevents delimiter ambiguities.</p> <h3 id="csv-loading">CSV Loading</h3> <p>On server startup, both CSV files are read once, skipping header rows and keeping an in-memory array of <code class="language-plaintext highlighter-rouge">{ date, close }</code> pairs per symbol. This avoids I/O during query handling and keeps latency consistent for multiple requests.</p> <h3 id="baseline-algorithms">Baseline Algorithms</h3> <ul> <li> <strong><code class="language-plaintext highlighter-rouge">PricesOnDate</code></strong> performs a lookup by matching ISO dates.</li> <li> <strong><code class="language-plaintext highlighter-rouge">MaxPossible</code></strong> computes the optimal profit or loss with respect to temporal order.</li> </ul> <p><br></p> <h2 id="refactor-highlights">Refactor Highlights</h2> <p>After revisiting the project, I improved two areas that matter to correctness and performance in production contexts.</p> <ol> <li><strong>ISO-8601 parsing without destructive tokenization</strong></li> </ol> <p>The original date checks used <code class="language-plaintext highlighter-rouge">strtok</code> directly on input buffers, which mutates the string and makes validation order dependent. I replaced this with an ISO-aware parser that leaves buffers intact and validates component ranges precisely.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Safe ISO-8601 date check: YYYY-MM-DD */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_valid_iso_date</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">"%4d-%2d-%2d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">1900</span> <span class="o">||</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">mdays</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">31</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">31</span><span class="p">};</span>
    <span class="kt">int</span> <span class="n">leap</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">%</span><span class="mi">4</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">y</span><span class="o">%</span><span class="mi">100</span><span class="o">!=</span><span class="mi">0</span> <span class="o">||</span> <span class="n">y</span><span class="o">%</span><span class="mi">400</span><span class="o">==</span><span class="mi">0</span><span class="p">));</span>
    <span class="kt">int</span> <span class="n">maxd</span> <span class="o">=</span> <span class="n">mdays</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">leap</span> <span class="o">&amp;&amp;</span> <span class="n">m</span><span class="o">==</span><span class="mi">2</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">d</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">d</span> <span class="o">&lt;=</span> <span class="n">maxd</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <ol> <li><strong>Linear-time profit or loss</strong></li> </ol> <p>The initial <code class="language-plaintext highlighter-rouge">MaxPossible</code> walked triple nested loops over the date range. I replaced this with O(n) scans. For profit, track the best buy so far and measure the spread to the current price. For loss, track the best sell so far when scanning from the right.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Profit in O(n): max(pr[j] - min_so_far) with j increasing */</span>
<span class="k">static</span> <span class="kt">double</span> <span class="nf">max_profit</span><span class="p">(</span><span class="k">const</span> <span class="kt">double</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">minp</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">best</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">minp</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">)</span> <span class="n">best</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">minp</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">minp</span><span class="p">)</span> <span class="n">minp</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">best</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Loss in O(n): max(max_so_far_from_right - pr[i]) using reverse scan */</span>
<span class="k">static</span> <span class="kt">double</span> <span class="nf">max_loss</span><span class="p">(</span><span class="k">const</span> <span class="kt">double</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">maxp</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">best</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">maxp</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">)</span> <span class="n">best</span> <span class="o">=</span> <span class="n">maxp</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">maxp</span><span class="p">)</span> <span class="n">maxp</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">best</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <ol> <li><strong>Correct rounding behavior</strong></li> </ol> <p>The specification requires rounding to two decimals. To guarantee rounding that matches financial expectations and the assignment’s rule, the close values are normalized with <code class="language-plaintext highlighter-rouge">ceilf(x * 100.0f) / 100.0f</code> when the spec calls for rounding up, or <code class="language-plaintext highlighter-rouge">roundf</code> for standard rounding. This is applied once at load time to avoid cumulative error.</p> <p><br></p> <h2 id="how-to-build-and-run">How to Build and Run</h2> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Compile</span>
gcc server.c <span class="nt">-o</span> server
gcc client.c  <span class="nt">-o</span> client

<span class="c"># Start server (choose a port in the allowed range)</span>
./server PFE.csv MRNA.csv 30000

<span class="c"># Start client and issue queries</span>
./client localhost 30000
<span class="o">&gt;</span> PricesOnDate 2019-07-02
PFE: 187.18 | MRNA: 44.98
<span class="o">&gt;</span> MaxPossible profit PFE 2019-09-11 2019-10-15
14.41
<span class="o">&gt;</span> quit
</code></pre></div></div> <p><br></p> <h2 id="what-i-learned">What I Learned</h2> <ul> <li> <strong>Message design matters</strong>. A minimal, length-prefixed frame simplified both sides of the wire and removed edge cases that often appear with delimiter-based protocols.</li> <li> <strong>Parsing is part of correctness</strong>. Non-destructive, ISO-aware date validation avoided subtle bugs when buffers were reused or shared.</li> <li> <strong>Asymptotic complexity is visible to users</strong>. Replacing cubic scans with single-pass analytics changed worst-case response time from seconds to milliseconds on modest hardware.</li> <li> <strong>Defensive I/O is not optional</strong>. Clear separation between loading, validation, and serving lowered the risk of runtime failures and improved observability.</li> </ul> </article> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> © Copyright 2025 Tongze Mao. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?70d799092f862ad98c7876aa47712e20"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>